# SM4 软件实现与优化说明文档

## 1. 项目概述
本项目实现了 **SM4 分组密码算法** 的软件版本，并在此基础上进行了性能优化，结合 **T-Table、SIMD 并行**、以及现代 CPU 指令集（AESNI、GFNI、VPROLD）加速，最终扩展实现了 **SM4-GCM 工作模式** 的加密与认证功能。

---

## 2. SM4 算法实现原理

### 2.1 SM4 基本结构
SM4 是中国国家密码算法标准，属于 **32轮迭代的分组密码**，主要特点：
- 分组长度：128 位
- 密钥长度：128 位
- 轮函数：非线性变换 + 线性变换
- 迭代轮数：32

SM4 核心公式：
$X_{i+4} = X_i \oplus T(X_{i+1} \oplus X_{i+2} \oplus X_{i+3} \oplus rk_i)$

其中：
- T 为非线性变换 + 线性变换：
  1. **非线性变换**（τ）：通过 8 位 S-box 映射
  2. **线性变换**（L）：通过循环移位实现
$L(B) = B \oplus (B \lll 2) \oplus (B \lll 10) \oplus (B \lll 18) \oplus (B \lll 24)$

### 2.2 S-box 与 T-Table
- S-box 用于非线性替换，提高密码强度
- 为优化性能，可使用 **T-Table** 将非线性与线性变换组合，实现查表替代循环移位：
$T\_table(x) = T0[x_0] \oplus T1[x_1] \oplus T2[x_2] \oplus T3[x_3]$
- 查表方式可以在 SIMD 并行中高效实现多块数据加密。

---

## 3. 指令集优化思路

### 3.1 AESNI
- AESNI 提供硬件加速 AES 的加密/解密指令
- 虽然 SM4 与 AES 算法不同，但 AESNI 的思路启发：
  - 通过 **硬件并行执行轮函数** 加速分组密码
  - 使用 SIMD 寄存器批量处理多块数据

### 3.2 GFNI（Galois Field New Instructions）
- GFNI 提供了 GF(2^8) 上仿射变换指令 `_mm_gf2p8affine_epi64_epi8`
- 可用于实现 S-box 的 GF(2^8) 并行变换
- 实际上：
  - 将 S-box 映射拆分为 **GF(2^8) 仿射 + 非线性部分**
  - 并行处理 16 字节数据
  - 提升轮函数执行速度

### 3.3 VPROLD / 位旋转优化
- VPROLD 提供 SIMD 位旋转指令，可加速 SM4 线性变换 `L()`
- 将循环移位操作批量并行执行，减少指令数
- 与 T-Table 配合，进一步提升吞吐量

### 3.4 SIMD 并行处理
- 使用 SSE2/SSSE3/AVX2 处理多块数据（2/4/8块）
- 每个 SIMD 寄存器处理一轮中的多个块
- 与 T-Table 或 GFNI 配合，实现轮函数的 **批量计算**

### 3.5 T-Table优化：
- 构造四张8×32位查找表，融合SBox与线性变换（L(T(x))）。
- 显著减少循环内计算量，提高速度。
- 实测加速比：单块加密约提速 1.5×~2×。

## 运行结果

以Intel x86_64 + SSE2/SSSE3平台为测试环境，对比如下（数据为估算值，单位：cycles/byte）：

| 实现版本              | 加密块数 | 平均耗时（cycles/byte） | 提速比（vs基础版） |
|-----------------------|----------|---------------------------|---------------------|
| 基础实现（无优化）    | 1        | 30.7                      | 1×                  |
| T-Table优化           | 1        | 19.9                      | ~1.54×              |
| SIMD并行（2块）       | 2        | 13.8                      | ~2.23×              |
| T-Table + SIMD（2块） | 2        | 11.2                      | ~2.74×              |

输出示例（2块加密）：

<img width="979" height="102" alt="image" src="https://github.com/user-attachments/assets/131d48a0-6ee9-47d2-97ee-b151119f6320" />

---


## 4. SM4-GCM 工作模式实现思路

### 4.1 GCM 基本概念
- GCM（Galois/Counter Mode）是一种 **计数器模式 + GMAC** 的组合
- 提供加密（CTR 模式）和认证（GMAC）双重功能
- 适用于高性能网络安全协议

### 4.2 SM4-GCM 加密流程
1. **初始化 IV**（通常 96 位）生成初始计数器 `Y0`
2. **加密数据**：
   $C_i = P_i \oplus \text{SM4}(Y_i)$
   
   其中 \(Y_i = Y_0 + i\)
3. **认证标签生成**：
   - 使用 GF(2^128) 乘法（Galois 域）对密文和附加数据生成认证标签
   - 可利用 GFNI 指令优化乘法
4. **输出**：密文 + 认证标签

### 4.3 SM4-GCM 优化点
- **批量计数器加密**：SIMD 并行处理多块 CTR
- **GF(2^128) 乘法加速**：GFNI 指令提升 GMAC 计算速度
- **T-Table + SIMD**：加速 SM4 单轮运算
- **位旋转优化**：加速线性变换 L()

<img width="1557" height="86" alt="image" src="https://github.com/user-attachments/assets/e7c9dff7-78a7-4db7-bb81-6a6c1e87e8d8" />



